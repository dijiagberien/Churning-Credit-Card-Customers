---
title: "Credit Card Customer Churn"
author: "Adogbeji Agberien"
date: "13/05/2021"
output: 
  html_document: 
    keep_md: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Background 

Customer churn is the loss/turnover of a client. For this analysis, the goal is to predict/classify customers who will churn.

```{r message = F, warning=F}
# Clear working directory
rm(list = ls())

# Import and load packages
required_packages <- c("RColorBrewer", "cowplot", 
                       "lubridate", 
                       "Hmisc", "psych",
                       "tidyverse", "data.table", 
                       "mlr3")

packageCheck <- lapply(required_packages, FUN = function(x) {
  if(!require(x, character.only = TRUE)) {
    install.packages(x, dependencies = TRUE)
    library(x, character.only = TRUE)
  }
})
```

```{r}
# Import data 
bank_churn <- fread("C:/Users/diji_/Desktop/Data Science/Projects/Bank Churn/BankChurners.csv")
```

```{r include = F}
bank_churn <- bank_churn[, c(-22, -23)]
```

```{r}
# Show the first 3 rows of the data 
head(bank_churn, 3)
```
We have some bit of features here, the first task will be to identify what the output feature is. In this case it is the Attrition_Flag. As shown below, the customers are either Existing or "Attrited" i.e., probably meaning they are no longer customers/clients. 

```{r}
unique(bank_churn$Attrition_Flag)
```

Next step is some Exploratory Data Analysis (EDA) and pre-processing. Thus far, the only input feature I see that is not necessary to be included in our model is the "CLIENTNUM", The CLIENTNUM is just an identifier. I won't remove it just yet though, in accordance with the theme of EDA I'll make a plot to see the relationship between the client ID and Attrition Flag. We have no time variable to evaluate the churning through time. So, my maybe flawed logic (*No bank manager to talk to lol*) is that the recent customers have higher client numbers than earlier customers...you know, customer 1, customer 2, ...., customer *n*, etc. 

Let us encode the response variable with 1 representing that the customer churned and 0 representing otherwise. 

```{r}
# Encode the response 
bank_churn$Attrition_Flag <- factor(bank_churn$Attrition_Flag, levels = c("Existing Customer", "Attrited Customer"), 
                                    labels = c(0, 1))
```

```{r}
ggplot() +
  geom_point(aes(x = bank_churn$CLIENTNUM, y = bank_churn$Attrition_Flag)) +
  xlab("Client Number") +
  ylab("Churn (1) or No churn (0)") +
  theme_classic()
```
Damn, no cigar! 

Let us find out what the other features mean so we can make sense of our data as we work through the challenge. 

Card_Category: 

Months_on_book: Period of relationship with the bank

Total_Relationship_Count: Total number of products held by the customer 

Months_Inactive_12_mon: No. of months inactive in the last 12 months 

Contacts_Count_12_mon: No of contacts in the last 12 months

Avg_Open_To_Buy: Open to buy credit line (Average of last 12 months)

Total_Amt_Chng_Q4_Q1: Change in transaction amount (Q4/Q1)

Total_Trans_Amt:  Total transaction amount in the last 12 months 

Total_Trans_Ct: Total transaction count in the last 12 months

Total_Ct_Chng_Q4_Q1: Change in transaction count (Q4/Q1)

```{r}
# Get the class of each variable
lapply(bank_churn, class) %>% t()
```

```{r}
Hmisc::describe(bank_churn$Attrition_Flag)
```

From above, and as represented in the pie plot below, we see that approx 16% of the credit card customers churned. As such, we can expect a challenge in training our model to predict customers who will churn...well, depending on the degree of similarity among customers who churned, and the degree of dissimilarity among customers who didn't churn.  

```{r}
# Create a table indicating churn proportions
churn_proportion <- table(bank_churn$Attrition_Flag) %>% data.table() %>% setnames(new = c("Activity", "Count"))
churn_proportion$`Percentage` <- round((churn_proportion$Count/sum(churn_proportion$Count))*100, 2)

# Create a pie chart to illustrate churn proportion
pie(churn_proportion$Count, labels = paste(factor(churn_proportion$Activity, levels = c(0, 1), labels = c("Existing customers", "Attrited customers")), sep = ", ", paste(churn_proportion$Percentage, sep = "", "%")), col = c("yellow4", "red"), 
    main = "Percantage of credit card customers who have churned.\n Total number of credit card customers: 10127")
```

still working .....